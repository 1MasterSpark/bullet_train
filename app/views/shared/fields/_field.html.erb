<% yield %>

<%
# returns a struct with `label`, `placeholder`, and `help` methods.
labels = labels_for(form, method)
options ||= {}
options[:id] ||= id_for(form, method)
options[:class] = "form-control #{options[:class]}".strip
# options[:disabled] ||= !field_editable?(form.object, method) if user_signed_in?
options[:placeholder] ||= labels.placeholder if labels.placeholder
other_options ||= {}
other_options[:help] = [other_options[:help], labels.help].compact.join(" ")

errors = [method, method.to_s.gsub(/_id$/, '').to_sym].uniq.map { |attribute| form.object.errors.full_messages_for(attribute) }.flatten
has_errors = errors.any? || content_for(:error).present? || other_options[:error].present?
%>

<div class="form-group <%= 'required' if presence_validated?(form.object, method) %> <%= 'has-error' if has_errors %>">

  <% # the label. %>
  <% unless other_options[:hide_label] == true %>
    <% if content_for? :label %>
      <%= yield :label %>
      <% flush_content_for :label %>
    <% else %>
      <% # allow the label to be defined via an inline option or else one of the locale yaml definitions. %>
      <% label = (other_options[:label].presence || labels.label || legacy_label_for(form, method)) %>
      <%= form.label method, label&.html_safe, class: 'asteriskable', for: options[:id] %>
    <% end %>
  <% end %>

  <% # the actual field. %>
  <% if content_for? :field %>
    <%= yield :field %>
    <% flush_content_for :field %>
  <% else %>
    <% # e.g. form.text_field(method, options) %>
    <%= form.send(helper, method, options) %>
  <% end %>

  <% # any error messages. %>
  <% if has_errors %>
    <small class="form-text text-danger form-control-feedback">
      <%= errors.map { |error| error + ". " }.join %>
      <%= yield :error %>
      <% flush_content_for :error %>
      <%= other_options[:error]&.html_safe %>
    </small>
  <% end %>

  <% # any help text. %>
  <% if content_for?(:help) || other_options[:help] || content_for?(:after_help) %>
    <small class="form-text text-muted form-control-feedback">
      <%= yield :help %>
      <% flush_content_for :help %>
      <%= other_options[:help]&.html_safe %>
      <%= yield :after_help %>
      <% flush_content_for :after_help %>
    </small>
  <% end %>

  <% if other_options[:icon] %>
  <div class="pre-icon os-icon <%= other_options[:icon] %>"></div>
  <% end %>

</div>
